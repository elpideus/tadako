#!/usr/bin/env node
"use strict";var ae=Object.create;var V=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var Ae=(I,n)=>()=>(n||I((n={exports:{}}).exports,n),n.exports);var Ie=(I,n,r,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let c of re(n))!le.call(I,c)&&c!==r&&V(I,c,{get:()=>n[c],enumerable:!(e=ie(n,c))||e.enumerable});return I};var D=(I,n,r)=>(r=I!=null?ae(oe(I)):{},Ie(n||!I||!I.__esModule?V(r,"default",{value:I,enumerable:!0}):r,I));var X=Ae((on,Te)=>{Te.exports={name:"tadako",version:"2.3.7",description:"An unofficial AnimeWorld API",author:"Stefan Cucoranu <elpideus@gmail.com>",license:"GPLv3",repository:{type:"git",url:"https://github.com/elpideus/tadako.git"},main:"index.js",type:"commonjs",keywords:["anime","data","information","api","scraping"],scripts:{build:"npx esbuild cli.ts --bundle --outfile=cli.js --platform=node --format=cjs --minify --target=node22 --external:cheerio --external:esbuild --external:puppeteer",reinstall:"npm uninstall -g tadako && npm install -g .",build_and_reinstall:"npm run build && npm run reinstall"},peerDependencies:{typescript:"^5.7.2"},dependencies:{cheerio:"^1.0.0",esbuild:"^0.24.2",puppeteer:"^24.1.1"},files:["index.ts","cli.ts","cli.js","src","src/Tadako.ts","LICENSE","tsconfig.json","README.md"],devDependencies:{"@types/node":"^22.10.4",typescript:"^5.7.3"},bin:{tadako:"cli.js"}}});var j=D(require("puppeteer")),z=D(require("cheerio"));var S={ANIME:0,MOVIE:4,OVA:1,ONA:2,SPECIAL:3,MUSIC:5};var b=(O=>(O.JAPANESE="jp",O.ITALIAN="it",O.CHINESE="ch",O.KOREAN="kr",O.ENGLISH="en",O))(b||{});var d={"ARTI MARZIALI":3,AVANGUARDIA:5,AVVENTURA:2,AZIONE:1,BAMBINI:47,COMMEDIA:4,DEMONI:6,DRAMMATICO:7,ECCHI:8,FANTASY:9,GIOCO:10,HAREM:11,HENTAI:43,HORROR:13,JOSEI:14,MAGIA:16,MECHA:18,MILITARI:19,MISTERO:21,MUSICALE:20,PARODIA:22,POLIZIA:23,PSICOLOGICO:24,ROMANTICO:46,SAMURAI:26,"SCI-FI":28,SCOLASTICO:27,SEINEN:29,SENTIMENTALE:25,SHOUJO:30,"SHOUJO AI":31,SHOUNEN:32,"SHOUNEN AI":33,"SLICE OF LIFE":34,SPAZIO:35,SOPRANNATURALE:37,SPORT:36,STORICO:12,SUPERPOTERI:38,THRILLER:39,VAMPIRI:40,VEICOLI:48,YAOI:41,YURI:42};var W={DEFAULT:0,NEW_ADDITIONS:1,NEW:1,A_TO_Z:2,ATOZ:2,ALPHABETICAL:2,Z_TO_A:3,ZTOA:3,OLDEST:4,LATEST:5,VIEWS:6,"MOST VIEWED":6,MOST_VIEWED:6};var Z={ONGOING:0,AIRING:0,FINISHED:1,UNRELEASED:2,DROPPED:3},F={"IN CORSO":0,IN_CORSO:0,INCORSO:0,FINITO:1,"NON RILASCIATO":2,NON_RILASCIATO:2,NONRILASCIATO:2,DROPPATO:3};var g=class{static parseItalianDate=n=>{let r={Gennaio:1,Febbraio:2,Marzo:3,Aprile:4,Maggio:5,Giugno:6,Luglio:7,Agosto:8,Settembre:9,Ottobre:10,Novembre:11,Dicembre:12};if(!n)return null;let e=n.trim().split(" ");if(e.length!==3)return null;let[c,O,N]=e,m=parseInt(c,10),p=r[O],_=parseInt(N,10);return!m||!p||!_?null:new Date(_,p-1,m)};static secondsToHumanTime=n=>{let r=Math.floor(n/86400);n%=24*3600;let e=Math.floor(n/3600);n%=3600;let c=Math.floor(n/60);n%=60;let O=[];return r>0&&O.push(`${r} day${r>1?"s":""}`),e>0&&O.push(`${e} hour${e>1?"s":""}`),c>0&&O.push(`${c} minute${c>1?"s":""}`),(n>0||O.length===0)&&O.push(`${n} second${n>1?"s":""}`),O.join(" ")}};var y=D(require("node:os"));var G=D(require("node:os")),K=D(require("node:path")),x=D(require("https")),B=D(require("fs"));var U=class{url;fileName;outputDir;constructor(n,r=null,e=null){this.url=n;let c=n.split("/");this.fileName=r??c[c.length-1],this.outputDir=e??K.default.join(G.homedir(),"Downloads")}downloadFile=async(n=Math.ceil(G.cpus().length/2),r=!0)=>{let e=K.default.join(this.outputDir,this.fileName),O=await new Promise((t,o)=>{x.default.get(this.url,{method:"HEAD"},A=>{if(A.statusCode!==200&&A.statusCode!==206){o(new Error(`Failed to fetch file headers: ${A.statusCode}`));return}t(A.headers)}).on("error",o)}),N=parseInt(O["content-length"]||"0",10);if(!N)throw new Error("Unable to determine file size.");try{if((await B.default.promises.stat(e)).size===N){console.log(`File already exists: ${this.fileName} (${(N/1024/1024).toFixed(2)} MB). Skipping download...`);return}}catch{}let m=Math.ceil(N/n),p=0,_=0,i=Date.now(),a=Date.now();console.log(`Downloading ${this.fileName} (${n} ${n>1?"threads":"thread"}) ...`);let l=0,s=setInterval(()=>{let t=p/N*100,o=(Date.now()-a)/1e3;Date.now()-i>=5e3&&(_=p/1024/1024/o,i=Date.now());let A=N-p,R=Math.floor(_>0?A/(_*1024*1024):0);process.stdout.clearLine(0),process.stdout.cursorTo(0);let M=N<2*1024*1024*1024?Math.floor(t):t.toFixed(2);process.stdout.write(`Downloaded: ${M}% (${(p/1024/1024).toFixed(2)} MB / ${(N/1024/1024).toFixed(2)} MB) - Speed: ${_.toFixed(2)} MB/s ETA: ${g.secondsToHumanTime(R)}`),l+=1},1e3),T=(t,o,A)=>new Promise((R,M)=>{let H={headers:{Range:`bytes=${t}-${o}`}};x.default.get(this.url,H,P=>{if(P.statusCode!==206){M(new Error(`Failed to download chunk ${A}: ${P.statusCode}`));return}let v=[];P.on("data",k=>{v.push(k),p+=k.length}),P.on("end",()=>{R(Buffer.concat(v))}),P.on("error",M)})}),E=[];for(let t=0;t<n;t++){let o=t*m,A=Math.min(N-1,(t+1)*m-1);E.push(T(o,A,t))}try{let t=await Promise.all(E);await B.default.promises.writeFile(e,Buffer.concat(t)),clearInterval(s);let o=`Finished downloading ${this.fileName} (${(N/1024/1024).toFixed(2)} MB) in ${g.secondsToHumanTime(l)}.
`;r?(console.clear(),console.log(o)):(process.stdout.clearLine(0),process.stdout.cursorTo(0),process.stdout.write(o))}catch(t){throw clearInterval(s),t}}};var J=D(require("node:path")),w=class{url;anime;constructor(n,r=null){this.url=n,this.anime=r}getDownloadURL=async()=>(await C.parse(this.url))("#download .widget.downloads .widget-body #alternativeDownloadLink").attr("href");download=async(n=null,r=null,e=Math.ceil(y.cpus().length/2))=>{if(n||(n=J.join(y.homedir(),"Downloads")),!r){let c=(await this.getDownloadURL())?.split("/");c&&c.length>1&&(r=c[c.length-1],await new U(await this.getDownloadURL()??"",r,n).downloadFile(e));return}await new U(this.url,r,n).downloadFile(e)}};var L=class{url;title="";alternativeTitle=null;poster=null;AniListURL=null;MyAnimeListURL=null;trailer=null;category=null;releaseDate=null;season=null;studio=null;genres=[];rating=null;duration=null;episodes=[];status=null;views=null;keywords=null;shortDescription=null;constructor(n,r={}){this.url=n,Object.assign(this,r)}data=async()=>(await this.init(),this);init=async()=>{let n=await C.parse(this.url);return this.title=n("#anime-title").text(),this.alternativeTitle=n("#anime-title").attr("data-jtitle")??this.alternativeTitle,this.poster=n("#main .content .widget.info .widget-body .row .info .thumb .img").attr("src")??this.poster,this.AniListURL=n("#anilist-button")?.attr("href")??this.AniListURL,this.MyAnimeListURL=n("#mal-button")?.attr("href")??this.MyAnimeListURL,this.trailer=n("#controls .trailer")?.attr("data-url")?`https://www.youtube.com/watch?v=${n("#controls .trailer")?.attr("data-url")?.split("/").pop()}`:this.trailer,this.category=S[n('dt:contains("Categoria:")').next().text().trim().toUpperCase()],this.releaseDate=g.parseItalianDate(n('dt:contains("Data di Uscita:")').next().text().trim()),this.season=n('dt:contains("Stagione:")').next().find("a").text().trim(),this.studio=n('dt:contains("Studio:")').next().find("a").text().trim(),n('dt:contains("Genere:")').next().find("a").each((r,e)=>{this.genres.push(d[n(e).text().trim().toUpperCase()])}),this.rating=parseFloat(n('dt:contains("Voto:")').next().find(".rating span").text().trim()),this.duration=n('dt:contains("Durata:")').next().text().trim(),n("#animeId .widget-body .server.active .episodes.range").each((r,e)=>{n(e).find("li.episode").each((c,O)=>{this.episodes.push(new w(`https://${C.domain}${n(O).find("a").attr("href")}`,this))})}),this.status=F[n('dt:contains("Stato:")').next().find("a").text().trim().toUpperCase()],this.views=parseInt(n('dt:contains("Visualizzazioni:")').next().text().trim()),this.keywords=n("#tagsReload").text(),this}};var C=class I{static domain="www.animeworld.so";static routes={list:"az-list",search:"filter"};static async parse(n){let r=await j.default.launch({headless:"shell",args:["--no-sandbox","--disable-setuid-sandbox"]}),e=await r.newPage();await e.setRequestInterception(!0),e.on("request",async O=>{let N=O.resourceType();["image","stylesheet","font","media","script"].includes(N)?await O.abort():await O.continue()}),await e.goto(n,{waitUntil:"domcontentloaded"});let c=await e.content();return await r.close(),z.load(c)}static async list(n=1,r=null){let e=await I.parse(`https://${this.domain}/${this.routes.list}`),c=parseInt(e("#main .content .widget.az-list .widget-body div .paging-wrapper #paging-form .total").text())||1,O=[];return e("#main .content .widget.az-list .widget-body .items .item").each((N,m)=>{let p=e(m);O.push(new L(`https://${I.domain}${p.find(".info .name").attr("href")}`,{title:p.find(".info .name").text(),shortDescription:p.find(".info p").text(),poster:p.find("a img").attr("src")||null,releaseDate:g.parseItalianDate(p.find(".info .name").attr("data-tippy-content")||"")||new Date}))}),{page:n>c?1:n,maxPages:c,results:O}}static async search(n="",r={}){let e=Object.entries(r).filter(([p,_])=>_!=null).map(([p,_])=>`${p}=${encodeURIComponent(_)}`).join("&"),c=await I.parse(`https://${this.domain}/${this.routes.search}?keyword=${n}&${e}`),O=[];c("#main .content .widget .widget-body .film-list .item").each((p,_)=>{let i=c(_),a=0;i.find("a.poster .status .movie")&&(a=4),i.find("a.poster .status .ova")&&(a=1),i.find("a.poster .status .ona")&&(a=2),i.find("a.poster .status .special")&&(a=3),i.find("a.poster .status .music")&&(a=5),O.push(new L(`https://${I.domain}${i.find(".inner a.name").attr("href")}`,{title:i.find(".inner a.name").text(),poster:i.find(".inner a.poster img").attr("src"),alternativeTitle:i.find(".inner a.name").attr("data-jtitle"),category:a}))});let N=c("#main .content .widget .widget-body .paging-wrapper #paging-form #page-input").attr("placeholder")||"1",m=c("#main .content .widget .widget-body .paging-wrapper #paging-form .total").text()||"1";return{page:r.page||parseInt(N),maxPages:parseInt(m),results:O,filters:r}}};var f=require("node:child_process"),$=D(require("readline")),h=D(require("node:path"));var u=D(require("node:os"));var se=D(require("fs")),Y={h:"help",v:"version",e:"episode",l:"language",c:"category",t:"threads",o:"out-dir",f:"filename"},Q=(I,n=Y)=>{let r={},e=null;for(let c=0;c<I.length;c++){let O=I[c];if(O.startsWith("--"))e=O.slice(2),r[e]=!0;else if(O.startsWith("-")){if(I.length<1)continue;let N=O.slice(1),m=n[N];m?(e=m,r[m]=!0):console.warn(`Unknown short flag: -${N}`)}else e&&(r[e]=O,e=null)}return r},q=async()=>{try{let I=se.default.readFileSync(h.join(__dirname,"help.json"),"utf-8");return JSON.parse(I)}catch(I){console.error("Error loading help file:",I),process.exit(1)}},ee="\x1B[32m\u25CF\x1B[0m",ne=" ",te=I=>`\x1B[32m${I}\x1B[0m`,Ee=async()=>{let I=process.argv.slice(2),n=I[0];if(n.length<5&&!n.startsWith("-")&&!n.startsWith("--")){console.warn("The query should be longer than 4 characters.");return}let r=I[1],e=Q(I.slice(2));if(n||(console.log("Usage: tadako <anime-title> <command> [--episode <episode-number>] [--language <language>] [other options]"),process.exit(1)),n==="--help"||n==="-h"){let{commands:i,flags:a}=await q();Object.keys(a).forEach(t=>{let o=Object.keys(Y).find(A=>`--${Y[A]}`===t);o&&(a[t].short=`-${o}`)});let l=Math.max(...Object.keys(a).map(t=>t.length),...Object.values(a).map(t=>t.short?.length||0)),s=Math.max(...Object.keys(i).map(t=>t.length)),T=Object.keys(a).map(t=>{let o=a[t],A=o.short?`, ${o.short}`:"",R=o.example?` [Example: ${o.example}]`:"";return`  ${(t+A).padEnd(l+8)}${o.info}${R}`}).join(`
`),E=Object.keys(i).map(t=>`  ${t.padEnd(s+4)}${i[t]}`).join(`
`);console.log(`Usage: tadako <anime-title> [<command>] [options]

The following commands are available:
${E}

The following options are available:
${T}`),process.exit()}if(n==="--version"||n==="-v"){let{version:i}=X();console.log(`Tadako Version: ${i}`),process.exit()}if(n&&!r||r.startsWith("--")||r.startsWith("-")){let{commands:i,flags:a}=await q();Object.keys(a).includes(n)||((n.startsWith("--")||n.startsWith("-"))&&(console.log(`"${n}" is not a valid flag. Please consult "tadako --help" for usage information.`),process.exit()),r="watch",e=Q(I.slice(1)))}let c=(i,a,l)=>{let s=process.stdout.rows,T=Math.max(0,a-Math.floor(s/2)),E=i.slice(T,T+l);console.clear();let t="";for(let o=0;o<E.length;o++){let A=T+o,R=A===a?ee:ne,M=A===a?te(E[o]):E[o];t+=`${R} ${M}
`}process.stdout.write(t)},O=async i=>{let a=$.createInterface({input:process.stdin,output:process.stdout,terminal:!0}),l=0,s=process.stdout.rows-2,T=(E,t)=>{t.name==="up"?l=l>0?l-1:i.length-1:t.name==="down"?l=l<i.length-1?l+1:0:t.name==="return"&&a.close(),c(i,l,s)};return c(i,l,s),a.input?.on("keypress",T),new Promise(E=>a.on("close",()=>E(i[l])))},N=(i,a,l=10)=>{let s=process.stdout.rows,T=Math.max(1,s-2),E=Math.max(0,Math.floor(a/l)-Math.floor(T/2)),t=i.slice(E*l,(E+T)*l);console.clear();let o="";for(let A=0;A<t.length;A++){let M=E*l+A===a;o+=`${M?ee:ne} ${M?te(t[A]):t[A]} `,(A+1)%l===0&&(o+=`
`)}process.stdout.write(o)},m=0,p=async(i,a=10)=>{let l=$.createInterface({input:process.stdin,output:process.stdout,terminal:!0}),s=0,T=Math.ceil(i.length/a),E=(t,o)=>{let A=Math.floor(s/a),R=s%a;o.name==="up"?s=A>0?s-a:(T-1)*a+R:o.name==="down"?s=A<T-1?s+a:R:o.name==="left"?s=R>0?s-1:A*a+(a-1):o.name==="right"?s=R<a-1&&s<i.length-1?s+1:A*a:o.name==="return"&&(m=s,l.close()),N(i.map((M,H)=>`${H+1}`),s,a)};return N(i.map((t,o)=>`${o+1}`),s,a),l.input?.on("keypress",E),new Promise(t=>l.on("close",()=>t(i[s])))},_=async()=>{let i={genre:e.genre?Number.isNaN(Number(e.genre??"null"))?d[e.genre.toUpperCase()]:e.genre:null,season:e.season||null,status:e.status?Number.isNaN(Number(e.status??"null"))?Z[e.status.toUpperCase()]??F[e.status.toUpperCase()]:e.status:null,year:e.year||null,type:e.type?Number.isNaN(Number(e.type??"null"))?S[e.type.toUpperCase()]:e.type:null,studio:e.studio||null,language:e.language||"it",sort:e.sort?Number.isNaN(Number(e.sort??"null"))?W[e.sort.toUpperCase()]:e.sort:4,dub:e.dub?Number.isNaN(Number(e.dub??"null"))?["TRUE","YES","SI"].includes(e.dub.toUpperCase())?"1":"0":e.dub:null},a=(await C.search(n,i)).results,l=0;if(a.length===0){if(!e.language){let t=Object.values(b);for(;l<t.length&&(i.language=t[l],a=(await C.search(n,i)).results,!(a.length>0));)l++}a.length===0&&(console.log(`No results found for "${n}" in any language.`),process.exit(1))}let s;if(a.length===1)s=a[0];else{let t=a.map(A=>A.title),o=await O(t);s=a.find(A=>A.title===o)}s||(console.log("Selected anime not found."),process.exit(1)),console.clear(),console.log("Loading episodes..."),await s.data();let T;e.all?T=s.episodes[0]:e.episode?T=s.episodes[e.episode-1]:s.episodes.length>1?T=await p(s.episodes):T=s.episodes[0],T||(console.log(`Episode ${e.episode} not found for "${s.title}"`),process.exit(1)),console.clear(),console.log("Anime loading...");let E=await T.getDownloadURL();return E||(console.log(`No download URL found for episode ${e.episode}`),process.exit(1)),{downloadURL:E,selectedAnime:s,selectedEpisode:T}};if(r==="watch"){let i=await _();console.clear(),(()=>{try{return(0,f.execSync)(`${e["mpv-dir"]?h.join(e["mpv-dir"],"mpv"):"mpv"} --version`,{stdio:"ignore"}),!0}catch{return!1}})()||(e["mpv-dir"]?console.log(`
The mpv location provided doesn't seem to be working.`):console.log("MPV is not installed or not working properly."),process.exit(1)),console.clear();let l=async(s,T=!1,E=[])=>{if(T)return new Promise((t,o)=>{(0,f.exec)(`${e["mpv-dir"]?h.join(e["mpv-dir"],"mpv"):"mpv"} "${s}" ${e.fullscreen?"--fullscreen":""}`,A=>{A?(console.error("Error executing MPV:",A),o(A)):t()})});{let t=[s];e.fullscreen&&t.push("--fullscreen"),(0,f.spawn)(e["mpv-dir"]?h.join(e["mpv-dir"],"mpv"):"mpv",t,{detached:!0,stdio:"ignore"}).unref()}};if(e["hold-cli"]||e.all)if(e.all){let s=e.episode?e.episode-1:0;for(let T of i.selectedAnime.episodes.slice(e.episode?e.episode-1:0)){console.clear(),s+=1,console.log(`"${i.selectedAnime.title}" episode ${s} is now playing via ${e["mpv-dir"]??"mpv"}\`...`),console.log("Use CTRL + C to stop watching.");let E=await T.getDownloadURL();E&&await l(E,!0)}}else console.log(`"${i.selectedAnime.title}" episode ${e.episode??m} is now playing via ${e["mpv-dir"]??"mpv"}\`...`),await l(i.downloadURL,!0);else console.log(`"${i.selectedAnime.title}" episode ${e.episode??m} is now playing via ${e["mpv-dir"]??"mpv"}\`...`),await l(i.downloadURL)}else if(r==="download"){let i=await _();console.clear();let a=(l,s=!0)=>new U(l,e.filename??null,e["out-dir"]??null).downloadFile(e.threads??Math.ceil(u.cpus().length/2),s);if(e.all){let l=Date.now(),s=i.selectedAnime,T=s.episodes;e.episode&&(T=s.episodes.slice(e.episode-1,s.episodes.length-1));let E;for(let R of T){let M=await R.getDownloadURL();M&&(E=await a(M,!1).then(),typeof E=="string"&&console.log(E))}let t=Date.now(),o=Math.ceil((t-l)/1e3),A=g.secondsToHumanTime(o);typeof E=="string"&&(console.clear(),console.log(`Downloaded ${T.length} (${e.episode??1} -> ${s.episodes.length}) episodes of ${s.title} in ${A}.`)),console.log(`Downloaded file(s) can be found in "${e["out-dir"]??h.join(u.homedir(),"Downloads")}"`)}else{let l=Date.now(),s=i.selectedAnime,T=i.selectedEpisode,E;e.episode&&(T=s.episodes[parseInt(e.episode)-1]);let t=await T.getDownloadURL();t&&(E=await a(t,!1),typeof E=="string"&&console.log(E));let o=Date.now(),A=Math.ceil((o-l)/1e3),R=g.secondsToHumanTime(A);typeof E=="string"&&(console.clear(),console.log(`Downloaded episode ${e.episode??m} of "${s.title}" in ${R}.`)),console.log(`Downloaded file(s) can be found in "${e["out-dir"]??h.join(u.homedir(),"Downloads")}"`)}process.exit()}else if(r==="link"){let i=await _(),a=await i.selectedEpisode.getDownloadURL();if(a)if(console.clear(),e.all){let l=i.selectedAnime,s=l.episodes;e.episode&&(s=l.episodes.slice(e.episode-1,l.episodes.length-1));let T=1;for(let E of s){let t=await E.getDownloadURL();t&&(console.log(`"${l.title}" episode ${T} link:`),console.log(t),T+=1)}}else console.log(`"${i.selectedAnime.title}" episode ${e.episode??m+1} link:`),console.log(a);else console.log("No download URL found for the selected anime/episode.")}else console.log("Invalid command or missing arguments"),process.exit(1)};require.main===module&&Ee().catch(I=>{console.error("Error:",I),process.exit(1)});
